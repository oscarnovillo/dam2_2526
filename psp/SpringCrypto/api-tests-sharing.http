### ========================================
### COMPARTIR SECRETOS - API
### ========================================
###
### Este archivo demuestra c√≥mo compartir secretos entre usuarios
### usando criptograf√≠a asim√©trica (RSA/EC)
###

### Variables
@baseUrl = http://localhost:8080/api/sharing
@userA = 1
@userB = 2

### ========================================
### PASO 1: Registrar Claves P√∫blicas
### ========================================
###
### Cada usuario debe generar un par de claves (RSA/EC) y registrar
### su clave P√öBLICA en el servidor.
### La clave PRIVADA nunca se env√≠a al servidor.
###
### JavaScript (generar par RSA):
### const keyPair = await crypto.subtle.generateKey(
###   {
###     name: "RSA-OAEP",
###     modulusLength: 2048,
###     publicExponent: new Uint8Array([1, 0, 1]),
###     hash: "SHA-256"
###   },
###   true,
###   ["encrypt", "decrypt"]
### );
###
### const publicKeyExported = await crypto.subtle.exportKey("spki", keyPair.publicKey);
### const publicKeyBase64 = btoa(String.fromCharCode(...new Uint8Array(publicKeyExported)));
###

### Usuario A registra su clave p√∫blica
POST {{baseUrl}}/public-key
Content-Type: application/json
X-User-Id: {{userA}}

{
  "publicKey": "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...",
  "algorithm": "RSA",
  "keySize": 2048
}

###

### Usuario B registra su clave p√∫blica
POST {{baseUrl}}/public-key
Content-Type: application/json
X-User-Id: {{userB}}

{
  "publicKey": "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...",
  "algorithm": "RSA",
  "keySize": 2048
}

### ========================================
### PASO 2: Obtener Clave P√∫blica de Otro Usuario
### ========================================
###
### Usuario A quiere compartir con Usuario B, necesita su clave p√∫blica
###

GET {{baseUrl}}/public-key/{{userB}}

### Respuesta esperada:
### {
###   "userId": 2,
###   "publicKey": "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...",
###   "algorithm": "RSA",
###   "keySize": 2048
### }

### ========================================
### PASO 3: Compartir Secreto
### ========================================
###
### Flujo en el CLIENTE:
### 1. Usuario A descifra su secreto con su password (AES)
### 2. Usuario A obtiene la clave p√∫blica de Usuario B (paso anterior)
### 3. Usuario A cifra el secreto con la clave p√∫blica de B (RSA)
###
### JavaScript (cifrar con RSA):
### const encrypted = await crypto.subtle.encrypt(
###   {
###     name: "RSA-OAEP"
###   },
###   publicKeyB, // Importada desde el Base64 del servidor
###   encoder.encode(secretData)
### );
###
### const encryptedBase64 = btoa(String.fromCharCode(...new Uint8Array(encrypted)));
###

### Usuario A comparte secreto #1 con Usuario B
POST {{baseUrl}}/share
Content-Type: application/json
X-User-Id: {{userA}}

{
  "secretId": 1,
  "sharedWithUserId": 2,
  "encryptedData": "dGVzdCBlbmNyeXB0ZWQgZGF0YSB3aXRoIFJTQQ==",
  "permission": "READ",
  "algorithm": "RSA",
  "expiresInDays": 30
}

### Respuesta esperada:
### {
###   "shareId": 1,
###   "secretId": 1,
###   "sharedWithUserId": 2,
###   "permission": "READ",
###   "createdAt": "2026-01-21T12:00:00",
###   "expiresAt": "2026-02-20T12:00:00"
### }

###

### Compartir con permiso de escritura
POST {{baseUrl}}/share
Content-Type: application/json
X-User-Id: {{userA}}

{
  "secretId": 2,
  "sharedWithUserId": 2,
  "encryptedData": "YW5vdGhlciBlbmNyeXB0ZWQgc2VjcmV0",
  "permission": "READ_WRITE",
  "algorithm": "RSA",
  "expiresInDays": null
}

### ========================================
### PASO 4: Ver Secretos Compartidos Conmigo
### ========================================
###
### Usuario B consulta qu√© secretos han compartido con √©l
###

GET {{baseUrl}}/shared-with-me
X-User-Id: {{userB}}

### Respuesta esperada:
### [
###   {
###     "shareId": 1,
###     "secretId": 1,
###     "ownerId": 1,
###     "sharedWithId": 2,
###     "encryptedData": "dGVzdCBlbmNyeXB0ZWQgZGF0YSB3aXRoIFJTQQ==",
###     "permission": "READ",
###     "algorithm": "RSA",
###     "createdAt": "2026-01-21T12:00:00",
###     "expiresAt": "2026-02-20T12:00:00",
###     "isExpired": false
###   }
### ]

### ========================================
### PASO 5: Acceder a un Secreto Compartido
### ========================================
###
### Usuario B obtiene un secreto espec√≠fico para descifrarlo
###

GET {{baseUrl}}/shares/1
X-User-Id: {{userB}}

### Respuesta: Mismo formato que shared-with-me
###
### Usuario B descifra en el CLIENTE con su clave privada:
###
### const decrypted = await crypto.subtle.decrypt(
###   {
###     name: "RSA-OAEP"
###   },
###   privateKeyB, // Nunca sali√≥ del dispositivo
###   ciphertextBytes
### );
###
### const secretData = new TextDecoder().decode(decrypted);

### ========================================
### PASO 6: Ver Secretos que He Compartido
### ========================================
###
### Usuario A consulta con qui√©n ha compartido
###

GET {{baseUrl}}/shared-by-me
X-User-Id: {{userA}}

### ========================================
### PASO 7: Ver Con Qui√©n He Compartido un Secreto
### ========================================
###
### Usuario A lista todas las personas con acceso al secreto #1
###

GET {{baseUrl}}/secret/1/shares
X-User-Id: {{userA}}

### Respuesta esperada:
### [
###   {
###     "shareId": 1,
###     "secretId": 1,
###     "ownerId": 1,
###     "sharedWithId": 2,
###     "permission": "READ",
###     ...
###   }
### ]

### ========================================
### PASO 8: Revocar Acceso
### ========================================
###
### Usuario A revoca el acceso de Usuario B al secreto #1
###

DELETE {{baseUrl}}/revoke/1/2
X-User-Id: {{userA}}

### Respuesta: 204 No Content
###
### Ahora Usuario B ya NO puede acceder al secreto #1

### ========================================
### FLUJO COMPLETO DE EJEMPLO
### ========================================

### 1. Usuario A crea secreto (vault normal)
POST http://localhost:8080/api/vault/secrets
Content-Type: application/json
X-User-Id: 1

{
  "encryptedData": "QUVTIGVuY3J5cHRlZCBzZWNyZXQ=",
  "iv": "MTIzNDU2Nzg5MDEy",
  "salt": "c2FsdDEyMzQ1Njc4",
  "metadata": null
}

### Guarda el secretId (ej: 1)

###

### 2. Usuario A registra clave p√∫blica
POST {{baseUrl}}/public-key
Content-Type: application/json
X-User-Id: 1

{
  "publicKey": "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuserA",
  "algorithm": "RSA",
  "keySize": 2048
}

###

### 3. Usuario B registra clave p√∫blica
POST {{baseUrl}}/public-key
Content-Type: application/json
X-User-Id: 2

{
  "publicKey": "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuserB",
  "algorithm": "RSA",
  "keySize": 2048
}

###

### 4. Usuario A obtiene clave p√∫blica de B
GET {{baseUrl}}/public-key/2

###

### 5. Usuario A comparte secreto #1 con B
### (despu√©s de cifrarlo con la clave p√∫blica de B)
POST {{baseUrl}}/share
Content-Type: application/json
X-User-Id: 1

{
  "secretId": 1,
  "sharedWithUserId": 2,
  "encryptedData": "c2VjcmV0IGVuY3J5cHRlZCB3aXRoIHVzZXJCIHB1YmxpYyBrZXk=",
  "permission": "READ",
  "algorithm": "RSA",
  "expiresInDays": 7
}

###

### 6. Usuario B consulta secretos compartidos
GET {{baseUrl}}/shared-with-me
X-User-Id: 2

###

### 7. Usuario B accede al secreto y lo descifra con su clave privada
GET {{baseUrl}}/shares/1
X-User-Id: 2

###

### 8. Usuario A revoca acceso de B (opcional)
DELETE {{baseUrl}}/revoke/1/2
X-User-Id: 1

### ========================================
### NOTAS DE SEGURIDAD
### ========================================
###
### ‚úÖ Buenas Pr√°cticas:
### - La clave privada NUNCA se env√≠a al servidor
### - La clave privada se guarda en:
###   - Web: IndexedDB (encriptada) o Session Storage
###   - Android: Android Keystore
###   - iOS: iOS Keychain
### - Usar RSA-OAEP (no PKCS#1 v1.5)
### - Usar EC (P-256) en vez de RSA si es posible (m√°s eficiente)
### - Implementar expiraci√≥n de compartidos
### - Logs de auditor√≠a (qui√©n comparti√≥ qu√© con qui√©n)
###
### ‚ö†Ô∏è Limitaciones:
### - El servidor ve QUI√âN comparte con QUI√âN (metadatos)
### - No ve el CONTENIDO del secreto
### - Si se revoca acceso, el usuario puede haber copiado el secreto
### - Para m√°xima seguridad: usar claves ef√≠meras por compartido
###
### üîí Privacidad:
### - Zero-Knowledge para el CONTENIDO
### - Metadata visible (qui√©n, cu√°ndo, con qui√©n)
### - Similar a Signal: servidor ve metadatos, no contenido

